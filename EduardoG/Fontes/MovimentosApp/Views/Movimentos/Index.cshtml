@model MovimentosApp.Models.MovimentoViewModel

@{
    ViewData["Title"] = "Movimentos Manuais";
}

<div class="container mt-4">
    <h2 class="mb-4 text-center">Movimentos Manuais</h2>

    <form asp-action="Incluir" method="post" id="formMovimento" class="border p-3 rounded shadow-sm">
        <div class="row mb-3">
            <div class="col-md-2">
                <label>Mês:</label>
                <input type="number" name="DAT_MES" value="@Model.Mes" class="form-control" />
            </div>
            <div class="col-md-2">
                <label>Ano:</label>
                <input type="number" name="DAT_ANO" value="@Model.Ano" class="form-control" />
            </div>
            <div class="col-md-4">
                <label>Produto:</label>
                <select id="produto" name="COD_PRODUTO" class="form-select">
                    <option value="">-- selecione --</option>
                    @foreach (var p in Model.Produtos)
                    {
                        <option value="@p.COD_PRODUTO">@p.DES_PRODUTO</option>
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label>Cosif:</label>
                <select id="cosif" name="COD_COSIF" class="form-select">
                    <option value="">-- selecione produto primeiro --</option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <input type="hidden" name="NUM_LANCAMENTO" value="@Model.ProximoNumeroLancamento" />
            <div class="col-md-3">
                <label>Valor:</label>
                <input type="number" step="0.01" name="VAL_VALOR" class="form-control" />
            </div>
            <div class="col-md-6">
                <label>Descrição:</label>
                <textarea name="DES_DESCRICAO" class="form-control"></textarea>
            </div>
        </div>

        <div class="text-center">
            <button type="reset" id="btnLimpar" class="btn btn-secondary me-2">Limpar</button>
            <button type="button" id="btnPesquisar" class="btn btn-success me-2" style="background-color: #4CAF50;">Pesquisar</button>
            <button type="submit" class="btn btn-primary">Incluir</button>
        </div>

    </form>

    <hr class="my-4" />

    <h4>Lista</h4>
<table class="table table-bordered table-striped mt-3" id="gridMovimentos">
    <thead class="table-light">
        <tr>
            <th>Mês</th>
            <th>Ano</th>
            <th>Código do Produto</th>
            <th>Descrição do Produto</th>
            <th>Número Lançamento</th>
            <th>Descrição</th>
            <th>Valor</th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Movimentos != null && Model.Movimentos.Any())
        {
            foreach (var item in Model.Movimentos)
            {
                <tr>
                    <td>@item.DAT_MES</td>
                    <td>@item.DAT_ANO</td>
                    <td>@item.COD_PRODUTO</td>
                    <td>@item.DES_PRODUTO</td>
                    <td>@item.NUM_LANCAMENTO</td>
                    <td>@item.DES_DESCRICAO</td>
                    <td>@item.VAL_VALOR.ToString("C")</td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="7" class="text-center text-muted">Nenhum movimento encontrado</td>
            </tr>
        }
    </tbody>
</table>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {

            const $produto = $('#produto');
            const $cosif = $('#cosif');
            const $tbody = $('#gridMovimentos tbody');

            // ========================
            // Funções utilitárias
            // ========================

            // Preenche o combo de COSIFs conforme o produto selecionado
            function carregarCosifs(codProduto) {
                $cosif.empty();

                if (!codProduto) {
                    adicionarOpcaoCosif('-- selecione produto primeiro --');
                    return;
                }

                $.get('/Movimentos/GetCosifs', { codProduto })
                    .done(function (data) {
                        if (!data || data.length === 0) {
                            adicionarOpcaoCosif('-- nenhum cosif disponível --');
                            return;
                        }

                        adicionarOpcaoCosif('-- selecione --');
                        data.forEach(item => {
                            $cosif.append(
                                $('<option>', {
                                    value: item.COD_COSIF,
                                    text: `${item.COD_COSIF} - ${item.COD_CLASSIFICACAO}`
                                })
                            );
                        });
                    })
                    .fail(() => {
                        adicionarOpcaoCosif('-- erro ao carregar cosifs --');
                    });
            }

            // Adiciona uma opção simples ao combo de COSIF
            function adicionarOpcaoCosif(texto, valor = '') {
                $cosif.append($('<option>', { value: valor, text: texto }));
            }

            // Carrega os movimentos no grid de acordo com mês e ano
            function carregarGrid() {
                const mes = $('input[name=DAT_MES]').val();
                const ano = $('input[name=DAT_ANO]').val();

                $tbody.empty();

                $.getJSON('/Movimentos/GetGrid', { mes, ano })
                    .done(function (data) {
                        if (!data || data.length === 0) {
                            adicionarLinhaTabela('Nenhum movimento encontrado');
                            return;
                        }

                        data.forEach(item => {
                            $tbody.append(`
                                <tr>
                                    <td>${item.DAT_MES}</td>
                                    <td>${item.DAT_ANO}</td>
                                    <td>${item.COD_PRODUTO}</td>
                                    <td>${item.DES_PRODUTO}</td>
                                    <td>${item.NUM_LANCAMENTO}</td>
                                    <td>${item.DES_DESCRICAO}</td>
                                    <td>R$ ${Number(item.VAL_VALOR).toFixed(2)}</td>
                                </tr>
                            `);
                        });
                    })
                    .fail(() => {
                        adicionarLinhaTabela('Erro ao carregar os movimentos');
                    });
            }

            // Adiciona uma linha de mensagem na tabela
            function adicionarLinhaTabela(mensagem) {
                $tbody.append(`
                    <tr>
                        <td colspan="7" class="text-center text-muted">${mensagem}</td>
                    </tr>
                `);
            }

            // ========================
            // Eventos
            // ========================

            // Quando trocar o produto → atualiza os COSIFs
            $produto.change(function () {
                carregarCosifs($(this).val());
            });

            // Botão PESQUISAR → recarrega a grid com os valores de mês e ano
            $('#btnPesquisar').click(carregarGrid);

            // Botão LIMPAR → reseta o combo COSIF e campos do formulário
            $('#btnLimpar').click(function () {
                adicionarOpcaoCosif('-- selecione produto primeiro --');
            });

            // ========================
            // Inicialização
            // ========================

            carregarGrid(); // já carrega ao abrir a página
        });
    </script>
}